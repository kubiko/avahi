name: avahi
version: 0
version-script: git describe --tags | cut -c 2-
summary: avahi-daemon 
description: |
  avahi service daemon

  Avahi is a free, LGPL implementation of DNS Service Discovery (DNS-SD RFC 6763) over Multicast DNS (mDNS RFC 6762),
  commonly known as and compatible with Apple Bonjour primarily targetting Linux.

  Copyright 2004-2015 by the Avahi developers.

confinement: strict
grade: stable

# expose services folder for other snaps
slots:
  services-content:
    interface: content
    content: avahi-services
    write:
      - $SNAP_COMMON/etc/avahi/services

apps:
    daemon:
        command: usr/sbin/avahi-daemon -f $SNAP_COMMON/etc/avahi/avahi-daemon.conf --no-drop-root --debug
        daemon: simple
        adapter: none
        environment:
          PATH: $SNAP/usr/sbin:$SNAP/usr/bin:$SNAP/sbin:$SNAP/bin:$PATH
          LD_LIBRARY_PATH: $SNAP_LIBRARY_PATH:$LD_LIBRARY_PATH:$SNAP/lib:$SNAP/usr/lib:$SNAP/usr/lib/${SNAPCRAFT_ARCH_TRIPLET}
        plugs:
          - network
          - network-bind
          - network-control
        slots:
          - avahi-observe
          - avahi-control

    browse:
        command: usr/bin/avahi-browse
        adapter: none
        environment:
          PATH: $SNAP/usr/sbin:$SNAP/usr/bin:$SNAP/sbin:$SNAP/bin:$PATH
          LD_LIBRARY_PATH: $SNAP_LIBRARY_PATH:$LD_LIBRARY_PATH:$SNAP/lib:$SNAP/usr/lib:$SNAP/usr/lib/${SNAPCRAFT_ARCH_TRIPLET}
        plugs:
          - network

    publish:
        command: usr/bin/avahi-publish
        adapter: none
        environment:
          PATH: $SNAP/usr/sbin:$SNAP/usr/bin:$SNAP/sbin:$SNAP/bin:$PATH
          LD_LIBRARY_PATH: $SNAP_LIBRARY_PATH:$LD_LIBRARY_PATH:$SNAP/lib:$SNAP/usr/lib:$SNAP/usr/lib/${SNAPCRAFT_ARCH_TRIPLET}
        plugs:
          - network
    resolve:
        command: usr/bin/avahi-resolve
        adapter: none
        environment:
          PATH: $SNAP/usr/sbin:$SNAP/usr/bin:$SNAP/sbin:$SNAP/bin:$PATH
          LD_LIBRARY_PATH: $SNAP_LIBRARY_PATH:$LD_LIBRARY_PATH:$SNAP/lib:$SNAP/usr/lib:$SNAP/usr/lib/${SNAPCRAFT_ARCH_TRIPLET}
        plugs:
          - network

    set-host-name:
        command: usr/bin/avahi-set-host-name
        adapter: none
        environment:
          PATH: $SNAP/usr/sbin:$SNAP/usr/bin:$SNAP/sbin:$SNAP/bin:$PATH
          LD_LIBRARY_PATH: $SNAP_LIBRARY_PATH:$LD_LIBRARY_PATH:$SNAP/lib:$SNAP/usr/lib:$SNAP/usr/lib/${SNAPCRAFT_ARCH_TRIPLET}
        plugs:
          - network

    help:
        command: bin/avahi-help
        adapter: none

parts:
    avahi:
        plugin: autotools
        source: .
        configflags:
          - --prefix=/usr
          - --disable-qt3
          - --disable-qt4
          - --disable-qt5
          - --disable-gtk
          - --disable-gtk3
          - --disable-gdbm
          - --disable-python
          - --disable-pygtk
          - --disable-python-dbus
          - --disable-mono
          - --disable-monodoc
          - --disable-manpages
          - --disable-xmltoman
          - --with-avahi-user=root
          - --with-avahi-group=root
          - --with-distro=debian
          - --disable-gobject
          - --sysconfdir=/var/snap/${SNAPCRAFT_PROJECT_NAME}/common/etc
          - --localstatedir=/var
        build-packages:
          - gettext
          - intltool
          - libexpat1-dev
          - libdaemon-dev
          - libglib2.0-dev
          - xmltoman
          - libdbus-1-dev
        stage-packages:
          - libdaemon0
        override-pull: |
            snapcraftctl pull
            # disable chown call, as it won't pass security confinement
            sed -i 's#chown(#// chown(#g' avahi-daemon/main.c
        override-build: |
            snapcraftctl build
            # add tag with txt record os=snappy
            sed -i '/<\/service>/ i\    <txt-record>os=snappy</txt-record>' $SNAPCRAFT_PART_INSTALL/var/snap/${SNAPCRAFT_PROJECT_NAME}/common/etc/avahi/services/ssh.service
        organize:
          var/snap/${SNAPCRAFT_PROJECT_NAME}/common/etc: etc
          var/snap/${SNAPCRAFT_PROJECT_NAME}/common/var: var
        stage:
          - -var/snap

    # snap helper scripts
    glue:
        source: glue
        plugin: dump
