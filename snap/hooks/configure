#!/bin/bash

set -x

exec >> $SNAP_COMMON/hook-${0}.log 2>&1
echo -e "\n$(date '+%Y-%m-%d %H:%M:%S') Entering hook"

# read key list
. $SNAP/bin/config
echo -e "Checking curretly defined keys"
for ((i=0;i<${#DEFINED_K[@]};++i)); do
    key=${DEFINED_K[$i]}
    value=$(snapctl get ${key})
    if [ "x$value" != "x" ]; then
        echo -e "\tupdating existing key: ${key} with ${value}"
        sed -i "s/.*${key}.*/${key}=${value}/g" $SNAP_COMMON/etc/avahi/avahi-daemon.conf
    fi
done

echo -e "Checking keys with no set value:"
for ((i=0;i<${#UNDEFINED_K[@]};++i)); do
    key=${UNDEFINED_K[$i]#?}
    value=$(snapctl get ${key})
    if [ "x$value" != "x" ]; then
        echo -e "\tupdating undefined key: ${key} with ${value}"
        sed -i "s/.*${key}.*/${key}=${value}/g" $SNAP_COMMON/etc/avahi/avahi-daemon.conf
    fi
done

# restart avahi daemon to make sure changes are applied
snapctl restart ${SNAP_NAME}
